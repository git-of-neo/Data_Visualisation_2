{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "data": {
      "url": "data/ne_110m_admin_0_countries.topojson",
      "format": {
            "type": "topojson",
            "feature": "ne_110m_admin_0_countries"
          }
    },
    "transform": [{
      "lookup": "properties.NAME",
      "from": {
        "data": {
          "url": "data/world-happiness-report-2021.csv"
        },
        "key": "Country name",
        "fields": ["Ladder score", "Regional indicator"]
      }
    },
    {"calculate":"toString(datum['Ladder score'])","as":"string score"}
    ],
    "vconcat":[
      {
        "width":"container",
        "height":350,
        "projection": {
          "type": "equalEarth"
        },
        "layer": [
          {
            "mark": {
              "type": "geoshape",
              "stroke":"darkslategray"
            },
            "encoding": {
              "color": {
                "field": "Ladder score",
                "type": "quantitative",
                "condition":{
                  "test":"datum['Ladder score'] == null",
                  "value":"#EEEEEE"
                },
                "scale":{
                  "zero":false,
                  "nice":true,
                  "scheme":"redyellowgreen"
                }
              },
              "opacity":{
                "condition":{"selection":"selected_region", "value":1},
                "value": 0.2
              },
              "tooltip": [
                {"field": "properties.NAME", "type": "nominal", "title": "Country"},
                {"field": "string score","title":"Score"}
              ]
            }
          },
          {
            "data":{"values":{}},
            "mark":{
              "type":"text",
              "align":"left",
              "fontSize":13,
              "fontStyle":"bold"
            },
            "encoding": {
              "longitude":{"datum":-160},
              "latitude":{"datum":0},
              "text":{"value":"Happiest Countries"}
            }
          },
          {
            "data":{"values":{}},
            "mark":{
              "type":"text",
              "align":"left",
              "dy":16,
              "fontSize":12
            },
            "encoding": {
              "longitude":{"datum":-160},
              "latitude":{"datum":0},
              "text":{"datum":["1.Finland","2.Denmark","3.Switzerland","4.Iceland","5.Netherlands","6. Norway", "7. Sweden", "8. Luxembourg", "9. New Zealand", "10. Austria"]}
            }
          }
        ]
      },
      {
        "data": {"url": "data/jitter.csv"},
        "width": "container",
        "layer":[
        {
          "selection":{
            "selected_region":{
              "type":"multi",
              "fields":["Regional indicator"],
              "bind":"legend"
            }
          },
          "mark": {
            "type": "point"
          },
          "encoding": {
            "y": {
                "field": "Ladder score", 
                "type": "quantitative",
                "scale": {"zero": false, "domainMin":2},
                "axis":{"grid": true, "title":"Ladder score", "titleFontSize": 14}
              },
            "color": {"field": "Regional indicator", "type": "nominal", "legend":{"labelLimit":130,"symbolOpacity":1}},
            "x": {
              "field": "Jitter",
              "type": "quantitative",
              "axis":null
            }, 
            "opacity":{
              "condition":{"selection":"selected_region", "value":{"expr": "datum['Ladder score'] > 5.532838926174494 ? 0.8 : 0.4"}},
              "value": 0.1
          },
            "tooltip":[
                {"field":"Ladder score"},
                {"field":"Country name"},
                {"field":"Regional indicator"}
              ]
          }
        },
        {
          "data" : {"url": "data/regional_average.csv"},
          "mark" : {"type":"tick", "orient":"horizontal"},
          "encoding": {
            "x":{"field":"Jitter","type": "quantitative"},
            "y":{"field":"Ladder score","type": "quantitative"},
            "color":{"value":"black"},
            "opacity":{
              "condition":{"selection":"selected_region", "value":1},
              "value": 0.1
            },
            "tooltip":[
              {"field":"Ladder score" , "title":"Regional average", "format":".2f"},
              {"field":"Regional indicator" , "title":"Region"}
            ]
          }
        },
        {
          "encoding": {
            "y":{"aggregate":"average","field":"Ladder score"},
            "tooltip":[{"aggregate":"average", "field":"Ladder score", "title":"Global average" , "format":".2f"}]
          },
          "layer": [{
            "mark":{"type":"rule", "strokeDash":[4]}
          },{
            "mark": {
              "type": "text",
              "align": "right",
              "baseline": "top",
              "dx": 2,
              "dy": 5,
              "x": "width",
              "text": "global average"
            }
          }
          ]
        }     
      ]
      }
    ]
    ,
    "config":{
      "mark": {"invalid": null},
      "autosize":"fit-x",
      "tick": {"thickness": 3, "size":20}
    }
}
  