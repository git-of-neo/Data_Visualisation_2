{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "title": "World Happiness Report 2021",
    "data": {
      "url": "data/ne_110m_admin_0_countries.topojson",
      "format": {
            "type": "topojson",
            "feature": "ne_110m_admin_0_countries"
          }
    },
    "transform": [{
      "lookup": "properties.NAME",
      "from": {
        "data": {
          "url": "data/world-happiness-report-2021.csv"
        },
        "key": "Country name",
        "fields": ["Ladder score", "Regional indicator"]
      }
    },{"calculate":"toString(datum['Ladder score'])","as":"string score"}
    ],
    "vconcat":[
      {
        "width":"container",
        "height":400,
        "projection": {
          "type": "equalEarth"
        },
        "encoding": {
          "color": {
            "field": "Ladder score",
            "type": "quantitative",
            "condition":{
              "test":"datum['Ladder score'] == null",
              "value":"#EEEEEE"
            },
            "scale":{
              "zero":false,
              "nice":true,
              "scheme":"redyellowgreen"
            }
          },
          "opacity":{
            "condition":{"selection":"selected_region", "value":1},
            "value": 0.2
          },
          "tooltip": [
            {"field": "properties.NAME", "type": "nominal", "title": "Country"},
            {"field": "string score","title":"Score"}
          ]
        },
        "layer": [
          {
            "mark": {
              "type": "geoshape"
            }
          },
          {
            "data":{"values":{}},
            "mark":"text",
            "encoding": {
              "text":{"value":{"expr": "'Finland no.1!!!'"}},
              "latitude":{"datum":40},
              "longitude":{"datum":180},
              "color":{"value":"black"},
              "tooltip":null
            }
          }
        ]
      },
      {
        "data": {"url": "data/jitter.csv"},
        "width": "container",
        "layer":[
        {
          "selection":{
            "selected_region":{
              "type":"multi",
              "fields":["Regional indicator"],
              "bind":"legend"
            }
          },
          "mark": {
            "type": "point"
          },
          "encoding": {
            "y": {
                "field": "Ladder score", 
                "type": "quantitative",
                "scale": {"zero": false},
                "axis":{"grid": false}
              },
            "color": {"field": "Regional indicator", "type": "nominal", "legend":{"labelLimit":130,"symbolOpacity":1, "interactive":true}},
            "x": {
              "field": "Jitter",
              "type": "quantitative",
              "axis":{"labels" : true, "title":null}
            }, 
            "opacity":{
              "condition":{"selection":"selected_region", "value":{"expr": "datum['Ladder score'] > 5.532838926174494 ? 0.8 : 0.4"}},
              "value": 0.1
          },
            "tooltip":[
                {"field":"Ladder score"},
                {"field":"Country name"},
                {"field":"Regional indicator"}
              ]
          }
        },
        {
          "data" : {"url": "data/regional_average.csv"},
          "mark" : {"type":"tick", "orient":"horizontal"},
          "encoding": {
            "x":{"field":"Jitter","type": "quantitative"},
            "y":{"field":"Ladder score","type": "quantitative"},
            "color":{"value":"black"},
            "opacity":{
              "condition":{"selection":"selected_region", "value":1},
              "value": 0.1
            },
            "tooltip":[
              {"field":"Ladder score" , "title":"Regional average", "format":".2f"},
              {"field":"Regional indicator" , "title":"Region"}
            ]
          }
        },
        {
          "encoding": {
            "y":{"aggregate":"average","field":"Ladder score"},
            "tooltip":[{"aggregate":"average", "field":"Ladder score", "title":"Global average" , "format":".2f"}]
          },
          "layer": [{
            "mark":{"type":"rule", "strokeDash":[4]}
          },{
            "mark": {
              "type": "text",
              "align": "right",
              "baseline": "top",
              "dx": 2,
              "dy": 5,
              "x": "width",
              "text": "global average"
            }
          }
          ]
        }
      ]
      }
    ]
    ,
    "config":{
      "mark": {"invalid": null}
      ,
      "autosize":"fit-x"
    }
}
  