{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width":"container",
  "height":300,
  "data": {
    "url":"data/world-happiness-report-2021.csv"
  },
  "transform": [
    {"joinaggregate": [{"field": "Ladder score", "as": "average score", "op": "average"}]},
    {"calculate": "datum['Ladder score'] - datum['average score']", "as": "score_deviation"}
  ],
  "params": [{
    "name": "N",
    "value":10,
    "bind":{
      "input": "range",
      "min": 2,
      "max": 20,
      "step": 1,
      "name": "Lowest N ranked : "
    }
  }],
  "layer": [
    {
      "transform": [
        {
          "window": 
          [{"op":"rank", "as": "rank"}], 
          "sort": [{"field": "Ladder score","order":"descending"}]
        },
        {"filter":"datum.rank >= (150-N)"}
      ],
      "encoding": {
        "y":{"field":"rank"},
        "x":{
          "aggregate":"sum",
          "field":"Ladder score"
        },
        "color":{
          "legend":null,
          "scale":{"scheme":"reds", "reverse":true}, 
          "field":"Ladder score"
        },
        "tooltip":[
          {"field":"Ladder score"},
          {"field":"Country name"},
          {"field":"score_deviation", "title":"Deviation from global average", "format":".2f"}
        ]
      },
      "layer": [
        {
          "mark":"bar"
        },
        {
          "mark":{
            "type": "text",
            "align":"left",
            "dx":3
          },
          "encoding": {
            "text":{
              "field":"Ladder score", 
              "format":".2f"
            },
            "color":{"value":"#b21218"}
          }
        },
        {
          "mark":{
            "type": "text",
            "align":"left",
            "dx":10
          },
          "encoding": {
            "x":{"datum":0},
            "text":{"field":"Country name"},
            "color":{"value":{"expr": "datum.rank < 150-N/2 ? 'black' : 'white'"}}
          }
        }
      ]
    }
  ],
  "config": {
    "view": {"stroke":null},
    "axis": {"disable": true}
  }
}